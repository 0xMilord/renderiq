# Prompt Flow Summary: Tool Prompts to Google Gemini

## ✅ Complete Flow Verified

### Flow Path for Tools

```
1. Tool Component (render-to-section-drawing.tsx)
   ├─ buildSystemPrompt() → Creates structured XML prompt
   └─ onGenerate(formData) → Sets formData.set('prompt', buildSystemPrompt())
                              Sets formData.append('imageType', tool.id) ✅

2. createRenderAction (render.actions.ts)
   ├─ Extracts: const prompt = formData.get('prompt')
   ├─ Extracts: const imageType = formData.get('imageType')
   └─ Passes to processRenderAsync with imageType ✅

3. processRenderAsync (render.actions.ts:377-388)
   ├─ Detects tool: const isToolPrompt = imageType?.startsWith('render-')
   ├─ ✅ PROTECTED: Skips reference render context if isToolPrompt
   └─ Passes prompt (unchanged) to aiService.generateImage()

4. AISDKService.generateImage (ai-sdk-service.ts:228-234)
   ├─ Detects tool: const isToolPrompt = prompt.includes('<role>') || ...
   ├─ ✅ PROTECTED: Skips environment/effect modifiers if isToolPrompt
   └─ Sends prompt (unchanged) to Gemini 3 Pro Image Preview ✅

5. Google Gemini API
   └─ Receives original structured XML prompt ✅
```

## ✅ Protection Mechanisms

### Protection 1: Reference Render Context
**Location**: `lib/actions/render.actions.ts:380-388`

**Detection**: `imageType` field starts with 'render-'

**Action**: Skips adding "Based on the previous render..." prefix

**Status**: ✅ **ACTIVE**

### Protection 2: Environment/Effect Modifiers
**Location**: `lib/services/ai-sdk-service.ts:228-234`

**Detection**: Prompt contains structured XML tags (`<role>`, `<task>`, `<constraints>`)

**Action**: Skips adding environment/effect modifiers

**Status**: ✅ **ACTIVE**

## ✅ Separation of Flows

### Tools Flow
- Uses: `createRenderAction` (server action)
- Route: Direct server action call
- Prompt: Structured XML from tool component
- Protection: ✅ Active

### Unified Chat Flow
- Uses: `/api/renders` (API route)
- Route: `/api/renders`
- Prompt: User input (can be modified)
- Protection: N/A (modifications are intentional)

**Status**: ✅ **NO INTERFERENCE** - Completely separate code paths

## ✅ Verification Checklist

- [x] Tool prompts use structured XML format
- [x] Tool prompts pass `imageType` field
- [x] `imageType` is passed to `processRenderAsync`
- [x] Tool detection works in `processRenderAsync`
- [x] Tool detection works in `AISDKService`
- [x] Reference render context is skipped for tools
- [x] Environment/effect modifiers are skipped for tools
- [x] Unified chat uses separate route
- [x] No prompt mixing between tools and chat

## ✅ Conclusion

**Tool prompts are fully protected and will be sent to Google Gemini exactly as generated by the tool component, without any modifications.**

The structured XML format is preserved throughout the entire flow, ensuring optimal results from Gemini 3 Pro Image Preview.

