# CDN DNS Configuration Guide for cdn.renderiq.io

## Quick Answer: Will This Break Anything?

**✅ NO BREAKING CHANGES!** The CDN setup is **backward compatible**:

- ✅ **New uploads** automatically use CDN (if `GCS_CDN_DOMAIN` is set)
- ✅ **Existing URLs** in database continue to work (they're stored as-is)
- ✅ **Components** already handle both `storage.googleapis.com` and CDN domains
- ✅ **No database migration needed** - old URLs still work

## DNS Configuration Steps

### Step 1: Run the CDN Setup Script

```bash
npm run gcs:cdn -- --domain=cdn.renderiq.io
```

This will:
- Create all Cloud CDN resources
- Get the Load Balancer IP address
- Update your `.env.local` with `GCS_CDN_DOMAIN=cdn.renderiq.io`

**Important:** Note the Load Balancer IP address from the script output!

### Step 2: Configure DNS Record

Go to your DNS provider (wherever `renderiq.io` is managed) and add:

**DNS Record Type:** `A` (or `AAAA` for IPv6)

**Name/Host:** `cdn` (or `cdn.renderiq.io` depending on your DNS provider)

**Value/Points to:** `YOUR_LOAD_BALANCER_IP` (from script output)

**TTL:** `3600` (1 hour) or `300` (5 minutes) for faster propagation

### Step 3: Wait for DNS Propagation

- **Typical time:** 5-60 minutes
- **Maximum time:** Up to 48 hours (rare)
- **Check status:** Use `dig cdn.renderiq.io` or `nslookup cdn.renderiq.io`

### Step 4: Verify DNS is Working

```bash
# Check if DNS resolves
dig cdn.renderiq.io

# Or
nslookup cdn.renderiq.io

# Should return your Load Balancer IP
```

### Step 5: Test CDN Access

```bash
# Test if CDN is accessible
curl -I https://cdn.renderiq.io/renderiq-renders/test-image.png

# Should return 200 OK (even if image doesn't exist, you'll get proper response)
```

## What Happens Automatically (No Action Needed)

### ✅ New Uploads
- All **new files** uploaded after setting `GCS_CDN_DOMAIN` will automatically use CDN URLs
- Example: `https://cdn.renderiq.io/renderiq-renders/...`
- **No code changes needed** - handled automatically by `GCSStorageService.getPublicUrl()`

### ✅ Existing URLs
- **Old URLs** in database (`storage.googleapis.com/...`) continue to work
- Components already handle both URL formats
- **No database updates required**

### ✅ Image Components
- All image components already check for CDN domain
- They use regular `<img>` tags for external URLs (including CDN)
- **No component updates needed**

## What You Might Want to Update (Optional)

### Option 1: Keep Old URLs (Recommended - Zero Risk)
- ✅ Do nothing
- ✅ Old URLs work fine
- ✅ New uploads use CDN automatically
- ✅ Gradual migration over time

### Option 2: Migrate Existing URLs (Optional - For Consistency)

If you want all URLs to use CDN for consistency:

```bash
# Update existing database URLs from storage.googleapis.com to CDN
npm run gcs:update-urls
```

**Note:** This script updates URLs in the database. Make sure to:
1. Backup your database first
2. Test on staging environment
3. Verify URLs work after migration

## Files That Handle CDN (Already Updated)

These files already support CDN - **no changes needed**:

### ✅ URL Generation
- `lib/services/gcs-storage.ts` - Automatically uses CDN if `GCS_CDN_DOMAIN` is set
- `lib/services/storage.ts` - Checks for CDN domain in existing URLs

### ✅ Image Components
- `components/home/hero-gallery-slideshow.tsx` - Handles CDN URLs
- `components/gallery/gallery-image-card.tsx` - Handles CDN URLs
- `components/home/pinterest-gallery.tsx` - Handles CDN URLs
- `components/engines/render-preview.tsx` - Handles CDN URLs
- All other image components - Check for `NEXT_PUBLIC_GCS_CDN_DOMAIN`

### ✅ URL Utilities
- `lib/utils/storage-url.ts` - `isGCSUrl()` checks for CDN domain
- `next.config.ts` - CDN domain added to `remotePatterns` automatically

## Environment Variables

After running the CDN setup script, your `.env.local` will have:

```env
# Cloud CDN Domain (auto-generated by setup-gcs-cdn.ts)
GCS_CDN_DOMAIN=cdn.renderiq.io
NEXT_PUBLIC_GCS_CDN_DOMAIN=cdn.renderiq.io
```

**Important:** 
- `GCS_CDN_DOMAIN` - Used by server-side code (URL generation)
- `NEXT_PUBLIC_GCS_CDN_DOMAIN` - Used by client-side code (image components)

## URL Format Comparison

### Before (Direct GCS)
```
https://storage.googleapis.com/renderiq-renders/projects/.../image.png
```

### After (CDN)
```
https://cdn.renderiq.io/renderiq-renders/projects/.../image.png
```

**Both formats work!** The code handles both automatically.

## Testing Checklist

After DNS is configured:

- [ ] DNS resolves: `dig cdn.renderiq.io` returns Load Balancer IP
- [ ] HTTPS works: `curl -I https://cdn.renderiq.io/renderiq-renders/test.png`
- [ ] New uploads use CDN: Upload a test image, check URL in database
- [ ] Old URLs still work: Check existing images in gallery
- [ ] Images load faster: Test from India/other regions

## Troubleshooting

### DNS Not Resolving
1. Check DNS record is correct (A record, points to Load Balancer IP)
2. Wait longer (can take up to 48 hours)
3. Clear DNS cache: `ipconfig /flushdns` (Windows) or `sudo dscacheutil -flushcache` (Mac)

### CDN Not Working
1. Verify `GCS_CDN_DOMAIN` is set in `.env.local`
2. Restart Next.js app after setting env var
3. Check Load Balancer is active in Cloud Console
4. Verify SSL certificate is provisioned (if using HTTPS)

### Images Still Slow
1. Check if URLs are using CDN domain (not `storage.googleapis.com`)
2. Wait for CDN cache to warm up (first request is slower)
3. Check CDN cache hit rate in Cloud Console
4. Verify cache headers are set correctly

## Summary

**DNS Setup:**
1. Run `npm run gcs:cdn -- --domain=cdn.renderiq.io`
2. Add A record: `cdn.renderiq.io` → Load Balancer IP
3. Wait for DNS propagation (5-60 minutes)
4. Done! ✅

**Breaking Changes:**
- ❌ **NONE!** Everything is backward compatible
- ✅ New uploads automatically use CDN
- ✅ Old URLs continue to work
- ✅ No database migration needed
- ✅ No code changes needed

**Optional:**
- Migrate existing URLs for consistency (not required)

---

**Need Help?** Check Cloud Console:
- Load Balancer: https://console.cloud.google.com/net-services/loadbalancing
- CDN: https://console.cloud.google.com/net-services/cdn

